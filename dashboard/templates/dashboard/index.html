{% extends "dashboard/base.html" %}

{% block title %}Enregistrement de Position avec Photo{% endblock %}

{% block extra_css %}
<style>
    #map { 
        height: 500px;
        width: 100%;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .user-marker {
        background-color: #3388ff;
        border-radius: 50%;
        border: 3px solid white;
        width: 30px;
        height: 30px;
    }
    .form-container {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }
    #photo-preview {
        margin-top: 15px;
        display: none;
    }
    #preview-img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
    .position-photo {
        max-width: 100px;
        max-height: 100px;
    }
    .error-message {
        color: #dc3545;
        font-size: 0.875em;
    }
    .is-invalid {
        border-color: #dc3545;
    }
    #save-btn .spinner {
        display: none;
    }
    #save-btn.loading .spinner {
        display: inline-block;
    }
    #save-btn.loading .text {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div id="alerts-container"></div>
    
    <h2 class="mb-4">Enregistrer ma position avec photo</h2>
    
    <div id="map"></div>
    
    <div class="form-container">
        <form id="position-form" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Prénom*</label>
                        <input type="text" id="first-name" name="first_name" class="form-control" required>
                        <div id="first-name-error" class="error-message"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Nom*</label>
                        <input type="text" id="last-name" name="last_name" class="form-control" required>
                        <div id="last-name-error" class="error-message"></div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Position* (cliquez sur la carte)</label>
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" id="latitude" name="latitude" class="form-control" placeholder="Latitude" readonly required>
                        <div id="latitude-error" class="error-message"></div>
                    </div>
                    <div class="col-md-6">
                        <input type="text" id="longitude" name="longitude" class="form-control" placeholder="Longitude" readonly required>
                        <div id="longitude-error" class="error-message"></div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="photo">Photo de la position</label>
                <input type="file" id="photo" name="photo" accept="image/*" capture="environment" class="form-control-file">
                <small class="form-text text-muted">Prenez une photo directement ou sélectionnez-en une</small>
            </div>
            
            <div id="photo-preview">
                <h5>Aperçu de la photo</h5>
                <img id="preview-img" src="#" alt="Aperçu de la photo">
            </div>
            
            <button type="button" id="save-btn" class="btn btn-primary mt-3" disabled>
                <span class="spinner-border spinner-border-sm spinner" role="status" aria-hidden="true"></span>
                <span class="text"><i class="fas fa-save"></i> Enregistrer ma position</span>
            </button>
        </form>
    </div>
    
    <div id="saved-positions" class="mt-4">
        <h4>Positions enregistrées</h4>
        <div id="positions-list" class="list-group"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialisation de la carte
    const map = L.map('map').setView([34, 9], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    
    let userMarker = null;
    let clickedPosition = null;
    
    // Gestion du clic sur la carte
    map.on('click', function(e) {
        clickedPosition = e.latlng;
        
        // Mettre à jour les champs
        $('#latitude').val(clickedPosition.lat.toFixed(6));
        $('#longitude').val(clickedPosition.lng.toFixed(6));
        
        // Activer le bouton d'enregistrement
        $('#save-btn').prop('disabled', false);
        
        // Supprimer l'ancien marqueur s'il existe
        if (userMarker) {
            map.removeLayer(userMarker);
        }
        
        // Ajouter un nouveau marqueur
        userMarker = L.marker(clickedPosition, {
            icon: L.divIcon({
                className: 'user-marker',
                iconSize: [30, 30]
            })
        }).addTo(map);
    });
    
    // Prévisualisation de la photo
    $('#photo').change(function() {
        const file = this.files[0];
        if (file) {
            // Vérification de la taille (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showAlert('danger', 'La photo ne doit pas dépasser 5MB');
                $(this).val('');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                $('#preview-img').attr('src', e.target.result);
                $('#photo-preview').show();
            }
            reader.readAsDataURL(file);
        } else {
            $('#photo-preview').hide();
        }
    });
    
    // Enregistrement de la position
    $('#save-btn').click(function() {
        // Réinitialisation des erreurs
        $('.error-message').empty();
        $('.is-invalid').removeClass('is-invalid');
        
        // Validation
        let isValid = true;
        const firstName = $('#first-name').val().trim();
        const lastName = $('#last-name').val().trim();
        
        if (!firstName) {
            $('#first-name').addClass('is-invalid');
            $('#first-name-error').text('Veuillez saisir votre prénom');
            isValid = false;
        }
        
        if (!lastName) {
            $('#last-name').addClass('is-invalid');
            $('#last-name-error').text('Veuillez saisir votre nom');
            isValid = false;
        }
        
        if (!clickedPosition) {
            $('#latitude').addClass('is-invalid');
            $('#longitude').addClass('is-invalid');
            $('#latitude-error').text('Veuillez sélectionner une position sur la carte');
            isValid = false;
        }
        
        if (!isValid) {
            showAlert('danger', 'Veuillez corriger les erreurs dans le formulaire');
            return;
        }
        
        // Création du FormData
        const formData = new FormData();
        formData.append('first_name', firstName);
        formData.append('last_name', lastName);
        formData.append('latitude', clickedPosition.lat);
        formData.append('longitude', clickedPosition.lng);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        // Ajout de la photo si elle existe
        const photoInput = $('#photo')[0];
        if (photoInput.files.length > 0) {
            formData.append('photo', photoInput.files[0]);
        }
        
        // Désactive le bouton pendant l'envoi
        const $btn = $(this);
        $btn.prop('disabled', true).addClass('loading');
        
        // Envoi AJAX
        $.ajax({
            url: '/save-position/',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    addToSavedList(response);
                    resetForm();
                    showAlert('success', 'Position enregistrée avec succès!');
                } else {
                    showAlert('danger', response.message || "Erreur lors de l'enregistrement");
                }
            },
            error: function(xhr) {
                let errorMsg = "Erreur serveur";
                try {
                    const res = JSON.parse(xhr.responseText);
                    errorMsg = res.message || errorMsg;
                } catch (e) {
                    console.error('Erreur:', e);
                }
                showAlert('danger', errorMsg);
            },
            complete: function() {
                $btn.prop('disabled', false).removeClass('loading');
            }
        });
    });
    
    // Fonction pour ajouter à la liste des positions sauvegardées
    function addToSavedList(data) {
        const photoHtml = data.photo_url 
            ? `<img src="${data.photo_url}" class="position-photo img-thumbnail mr-3" alt="Photo">`
            : '';
            
        $('#positions-list').prepend(`
            <div class="list-group-item">
                <div class="d-flex align-items-center">
                    ${photoHtml}
                    <div class="flex-grow-1">
                        <h5>${data.first_name} ${data.last_name}</h5>
                        <small class="text-muted">
                            Lat: ${parseFloat(data.latitude).toFixed(4)}, 
                            Lng: ${parseFloat(data.longitude).toFixed(4)}
                        </small>
                    </div>
                    <button class="btn btn-sm btn-info view-btn" 
                            data-lat="${data.latitude}" 
                            data-lng="${data.longitude}">
                        <i class="fas fa-map-marker-alt"></i> Voir
                    </button>
                </div>
            </div>
        `);
    }
    
    // Gestion du clic sur le bouton "Voir"
    $(document).on('click', '.view-btn', function() {
        const lat = $(this).data('lat');
        const lng = $(this).data('lng');
        map.setView([lat, lng], 15);
    });
    
    // Fonction pour réinitialiser le formulaire
    function resetForm() {
        $('#position-form')[0].reset();
        $('#photo-preview').hide();
        if (userMarker) {
            map.removeLayer(userMarker);
            userMarker = null;
        }
        clickedPosition = null;
        $('#save-btn').prop('disabled', true);
    }
    
    // Fonction pour afficher les alertes
    function showAlert(type, message) {
        const alert = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>`;
        $('#alerts-container').html(alert);
    }
    
    // Chargement initial des positions existantes
    function loadSavedPositions() {
        $.ajax({
            url: '/api/saved-positions/',
            type: 'GET',
            success: function(data) {
                data.forEach(position => {
                    addToSavedList(position);
                });
            },
            error: function() {
                console.error("Erreur lors du chargement des positions existantes");
            }
        });
    }
    // Exemple avec Fetch API
async function savePosition(positionData) {
    const formData = new FormData();
    formData.append('first_name', positionData.firstName);
    formData.append('last_name', positionData.lastName);
    formData.append('latitude', positionData.latitude);
    formData.append('longitude', positionData.longitude);
    
    if (positionData.photo) {
        formData.append('photo', positionData.photo);
    }

    try {
        const response = await fetch('/save-position/', {
            method: 'POST',
            body: formData,
            // Pas besoin de headers Content-Type avec FormData,
            // le navigateur le fera automatiquement avec le boundary
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.message || 'Erreur lors de la sauvegarde');
        }
        return data;
    } catch (error) {
        console.error('Erreur:', error);
        throw error;
    }
}

// OU en JSON
async function savePositionJson(positionData) {
    try {
        const response = await fetch('/save-position/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'), // Si vous utilisez CSRF
            },
            body: JSON.stringify({
                first_name: positionData.firstName,
                last_name: positionData.lastName,
                latitude: positionData.latitude,
                longitude: positionData.longitude,
                // Note: Vous ne pouvez pas envoyer de fichier avec JSON
            }),
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.message || 'Erreur lors de la sauvegarde');
        }
        return data;
    } catch (error) {
        console.error('Erreur:', error);
        throw error;
    }
}
    
    // Chargement initial
    loadSavedPositions();
});
</script>
{% endblock %}